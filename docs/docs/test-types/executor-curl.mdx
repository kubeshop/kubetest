import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# cURL
Testkube is able to run cURL commands as tests.

## Abstraction over curl
Testkube executor provides an abstraction over curl, that allow you to create JSON-based curl test files. They allow you to combine curl command with expected results:

- `expected_status` allow you to assert specific status code is returned
- `expected_body` allow to validate the body of the response.

Below is an example of how to format the test:

```js
{
  "command": [
    "curl",
    "https://reqbin.com/echo/get/json",
    "-H",
    "'Accept: application/json'"
  ],
  "expected_status": "200",
  "expected_body": "{\"success\":\"true\"}"
}
```

You can also find this test in the Testkube repository: https://github.com/kubeshop/testkube/blob/main/test/curl/curl.json

## Example test
In this example we will use the following curl test: https://github.com/kubeshop/testkube/blob/main/test/curl/executor-tests/curl-smoke-test.json

```js
{
	"command": [
	  "curl",
	  "https://testkube.io/"
	],
	"expected_status": "200"
}
```

## Creating and running Test

<Tabs groupId="dashboard-cli">
<TabItem value="dash" label="Dashboard">

If you prefer to use Dashboard, just go to Tests, and click `Add a new test` button. Then you need to fill in the test Name, choose the test Type (`curl/test`), and then choose Test Source.

### File
In case of File source the test file is uploaded directly.

![curl test - creation dialog - file](../img/dashboard-curl-create-test-file.png)

### Git file
In case of Git file you need to fill in repository details - Git repository URI (in this case `https://github.com/kubeshop/testkube.git`), branch (`main`), and path to curl test in your repository (`test/curl/executor-tests/curl-smoke-test.json`). In this example, the repository is public, but in case of private ones you mwould need to additionally fill in Git credentials.

![curl test - creation dialog - git file](../img/dashboard-curl-create-test-git-file.png)

</TabItem>
<TabItem value="cli" label="CLI">

If you prefer using the CLI, you can create the test with `testkube create test`.

You need to set:

- `--name` (for example, `curl-test`)
- `--type` (in this case `curl/test`)

And, then choose Test Content type based on Test Source you want to use:

### File

In case of File test source:

- `--test-content-type` (`file-uri`)
- `--file` (path to your curl test - in this case `test/curl/executor-tests/curl-smoke-test.json`)

```sh
testkube create test --name curl-test --type curl/test --test-content-type file-uri --file test/curl/executor-tests/curl-smoke-test.json
```

```sh title="Expected output:"
Test created testkube / curl-test ðŸ¥‡
```

You can then run the test with `testkube run test curl-test`.

### Git file

- `--test-content-type` (`git-file`, so specific file will be checked out from the Git repository)
- `--git-uri` - repository URI (in case of this example, `https://github.com/kubeshop/testkube.git`)
- `--git-branch`
- `--git-path` - path to the k6 script in the repository (in this case `test/curl/executor-tests/curl-smoke-test.json`)

```sh
testkube create test --name curl-test --type curl/test --test-content-type git-file --git-uri https://github.com/kubeshop/testkube.git --git-branch main --git-path test/curl/executor-tests/curl-smoke-test.json
```

```sh title="Expected output:"
Test created testkube / curl-test ðŸ¥‡
```

You can then run the test with `testkube run test curl-test`.

</TabItem>
<TabItem value="crd" label="Custom Resource">

//TODO: CRD

</TabItem>
</Tabs>


The test Custom Resource Definition (CRD) should be created with the type `curl/test`.




///////////////////////////////





## **Running Tests Using cURL Commands**

### **Creating and Running a cURL Test**

Save a test in a format as described above. In this example, it is `curl-test.json`.

Create the test by running `testkube create test --file curl-test.json --name curl-test --type "curl/test"`.

Check if the test was created using the command `testkube get tests`. The output will be similar to:


```bash
       NAME       |        TYPE         
+-----------------+--------------------+
  curl-test      | curl/test  
```

The test can be run using `kubectl testkube run test curl-test` which gives the output:

```bash
Type          : curl/test
Name          : curl-test
Execution ID  : 613a2d7056499e6e3d5b9c3e
Execution name: sadly-optimal-ram

Test queued for execution

Use the following command to get test execution details:
$ kubectl testkube get execution 613a2d7056499e6e3d5b9c3e

Or watch the script execution until complete:
$ kubectl testkube watch execution 613a2d7056499e6e3d5b9c3e
```

As seen above, results can be checked using `testkube get execution 613a2d7056499e6e3d5b9c3e`, where the id of the execution is unique for each execution. Ensure that the correct id is used. The output will look something like:

```bash
Name: painfully-super-colt,Status: success,Duration: 534ms

HTTP/2 200 
date: Thu, 09 Sep 2021 15:51:15 GMT
content-type: application/json
content-length: 19
last-modified: Thu, 09 Sep 2021 13:07:39 GMT
cache-control: max-age=31536000
cf-cache-status: HIT
age: 6939
accept-ranges: bytes
expect-ct: max-age=604800, report-uri="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"
report-to: {"endpoints":[{"url":"https:\/\/a.nel.cloudflare.com\/report\/v3?s=OZHPfvLjuVhpklzeGvhs8Ic0w%2FJ1%2BKgMcXeichnmMt9lKxF%2Fkco%2FHD2Z2vWfvInH9IPNuAQpjKu1Roqy8efIhVztIhvBP14Wx4wdBsQhzxUe9znZ%2Fmanwsky5G3Q"}],"group":"cf-nel","max_age":604800}
nel: {"success_fraction":0,"report_to":"cf-nel","max_age":604800}
server: cloudflare
cf-ray: 68c193af1f706571-LHR
alt-svc: h3=":443"; ma=86400, h3-29=":443"; ma=86400, h3-28=":443"; ma=86400, h3-27=":443"; ma=86400

{"success":"true"}
```

There is a generated name for the execution, the status, duration and the output of the cURL command.
