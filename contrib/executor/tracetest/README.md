![Testkube Logo](https://raw.githubusercontent.com/kubeshop/testkube/main/assets/testkube-color-gray.png)

# Welcome to TestKube Tracetest Executor

TestKube Tracetest Executor is a test executor to run [Tracetest](https://tracetest.io/) tests with [TestKube](https://testkube.io).

# Running Tracetest with Testkube

[Tracetest](https://tracetest.io/) is a testing tool based on [OpenTelemetry](https://opentelemetry.io/) that permits you to test your distributed application. It allows you to use the trace data generated by your OpenTelemetry tools to check and assert if your application has the desired behavior defined by your test definitions.

[Testkube](https://testkube.io/) is a Kubernetes-native testing framework for Testers and Developers that allows you to automate the executions of your existing testing tools inside your Kubernetes cluster, removing all the complexity from your CI/CD/GitOps pipelines.

By using the [Testkube Tracetest Executor](https://github.com/kubeshop/testkube-executor-tracetest) you can unlock Testkube's capacity in conjunction with Tracetest, and leverage the work you have already done to instrument your services.

## Quickstart

Here we will show how to use Testkube alongside Tracetest to run your tests in a Kubernetes cluster.

### Prerequisites

In your Kubernetes cluster you should have:

1. `Testkube`: Use HELM or the Testkube CLI to [install](https://kubeshop.github.io/testkube/installing) Testkube Server components in your cluster.
2. `Tracetest`: You need a running instance of [Tracetest](https://docs.tracetest.io/getting-started/installation/) or [Tracetest Core](https://docs.tracetest.io/core/getting-started/installation/) which is going to be executing your assertions. To do so you can follow the instructions defined in the Tracetest [documentation](https://docs.tracetest.io/getting-started/overview).
3. `OpenTelemetry Instrumented Service`: To generate traces and spans, the service under test must support the basics for [propagation](https://opentelemetry.io/docs/reference/specification/context/api-propagators/) through HTTP requests, and also store traces and spans in a Data Store Backend (Jaeger, Grafana Tempo, OpenSearch, etc) or use the [OpenTelemetry Collector](https://docs.tracetest.io/configuration/overview#using-tracetest-without-a-trace-data-store).

On your machine you should have:

1. `Kubectl` [installed](https://kubernetes.io/docs/tasks/tools/)
2. `Testkube CLI` [installed](https://kubeshop.github.io/testkube/installing#1-installing-the-testkube-cli)

With everything set up, we will start configuring Testkube and Tracetest.

### 1. Deploy the Tracetest Executor

Testkube works with the concept of [Executors](https://kubeshop.github.io/testkube/test-types/executor-custom). An Executor is a wrapper around a testing framework (Tracetest in this case) in the form of a Docker container and runs as a Kubernetes job. To start you need to register and deploy the Tracetest executor in your cluster using the Testkube CLI:

```bash
kubectl testkube create executor --image kubeshop/testkube-executor-tracetest:latest --types "tracetest/test" --name tracetest-executor
```

### 2. Create your test

Now you need a Tracetest test. Have a look at the [Tracetest documentation](https://docs.tracetest.io/cli/creating-tests) for details on writing tests. Here is a simple test definition example:

```yaml
type: Test
spec:
  id: R5NITR14g
  name: Pokeshop - List
  description: Get a Pokemon
  trigger:
    type: http
    httpRequest:
      url: http://demo-pokemon-api.demo/pokemon?take=20&skip=0
      method: GET
      headers:
        - key: Content-Type
          value: application/json
  specs:
    - selector: span[tracetest.span.type="http"]
      assertions:
        - attr:http.method = "GET"
    - selector: span[tracetest.span.type="database"]
      assertions:
        - attr:db.name = "pokeshop"
```

Execute the following command to create the test executor object in Testkube. Do not forget to provide the path to your Tracetest definition file using the `--file` argument, and also the Tracetest Server endpoint using the `TRACETEST_ENDPOINT` `--variable`:

```bash
kubectl testkube create test --file my/file/location.yaml --type "tracetest/test" --name pokeshop-tracetest-test --variable TRACETEST_ENDPOINT=http://tracetest
```

### 3. Run your test

Finally, to see the integration working, you only need to run the test by executing the following command:

```bash
kubectl testkube run test --watch pokeshop-tracetest-test
```

# Architecture

The following is a high-level sequence diagram of how Testkube and Tracetest interact with the different pieces of the system:

```mermaid
sequenceDiagram
    participant testkubeClient as Testkube Client
    participant testkube as Testkube
    participant executorCRDs as Executor CRDs
    participant tracetestExecutorJob as Tracetest Executor Job
    participant tracetestServer as Tracetest
    participant instrumentedService as Instrumented Service
    participant dataStore as Data Store

    testkubeClient->>+testkube:                   Trigger Testkube test run
    testkube->>+executorCRDs:                     Get executor details
    executorCRDs-->>-testkube:                    Send details
    testkube->>+tracetestExecutorJob:             Schedules execution
    tracetestExecutorJob->>+tracetestExecutorJob: Configure Tracetest CLI
    tracetestExecutorJob->>+tracetestServer:      Executes the Tracetest test run
    tracetestServer->>+instrumentedService:       Trigger request
    instrumentedService-->>-tracetestServer:      Get response
    instrumentedService->>+dataStore:             Send telemetry data
    tracetestServer->>+dataStore:                 Fetch trace
    dataStore-->>-tracetestServer:                Get trace
    tracetestServer->>+tracetestServer:           Run assertions
    tracetestServer-->>-tracetestExecutorJob:     Return test run results
    tracetestExecutorJob-->>-testkube:            Return test run results
    testkube-->>-testkubeClient:                  Send details
```

# Issues and enhancements

Please follow the main [TestKube repository](https://github.com/kubeshop/testkube) for reporting any [issues](https://github.com/kubeshop/testkube/issues) or [discussions](https://github.com/kubeshop/testkube/discussions)

# Testkube

For more info go to [main testkube repo](https://github.com/kubeshop/testkube)

![Release](https://img.shields.io/github/v/release/kubeshop/testkube) [![Releases](https://img.shields.io/github/downloads/kubeshop/testkube/total.svg)](https://github.com/kubeshop/testkube/tags?label=Downloads) ![Go version](https://img.shields.io/github/go-mod/go-version/kubeshop/testkube)

![Docker builds](https://img.shields.io/docker/automated/kubeshop/testkube-api-server) ![Code build](https://img.shields.io/github/workflow/status/kubeshop/testkube/Code%20build%20and%20checks) ![Release date](https://img.shields.io/github/release-date/kubeshop/testkube)

![Twitter](https://img.shields.io/twitter/follow/thekubeshop?style=social)

#### [Documentation](https://kubeshop.github.io/testkube) | [Slack](https://testkubeworkspace.slack.com/join/shared_invite/zt-2arhz5vmu-U2r3WZ69iPya5Fw0hMhRDg#/shared-invite/email)

# Tracetest

For more info go to [main tracetest repo](https://github.com/kubeshop/tracetest)

![Twitter](https://img.shields.io/twitter/follow/tracetest_io?style=social)

#### [Documentation](https://docs.tracetest.io/) | [Slack](https://testkubeworkspace.slack.com/join/shared_invite/zt-2arhz5vmu-U2r3WZ69iPya5Fw0hMhRDg#/shared-invite/email)