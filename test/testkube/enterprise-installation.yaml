apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: enterprise-installation-test
  labels:
    core-tests: installation
spec:
  system:
    pureByDefault: true
  content:
    files:
    - path: /root/edge-cluster-sa-key.json
      contentFrom:
        secretKeyRef:
          name: sa-key
          key: json-sa-key
  container:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest # contains gcloud, gke-gcloud-auth-plugin and kubectl
  steps:
  - name: Install Helm
    shell: |
      # Install helm
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      helm version
  - name: Install Testkube CLI
    shell: |
      wget -qO - https://repo.testkube.io/key.pub | apt-key add -
      echo "deb https://repo.testkube.io/linux linux main" | tee -a /etc/apt/sources.list
      apt-get update && apt-get install -y testkube
  - name: gcloud auth
    shell: |
      gcloud auth activate-service-account gh-actions-deploy@testkube-328312.iam.gserviceaccount.com --key-file=/root/edge-cluster-sa-key.json
      gcloud container clusters get-credentials testkube-cloud-edge --region us-east1 --project testkube-328312
  - name: Test
    shell: |
      helm version
      # TODO: secret
      testkube init demo --namespace testkube-enterprise-installation-test --no-confirm --license AAAAAAAAAAAAAAAAAAAAAAAAAAAA --helm-set testkube-agent.testkube-api.multinamespace.enabled=true --helm-set testkube-agent.testkube-operator.enabled=false --helm-set dex.rbac.createClusterScoped=false
