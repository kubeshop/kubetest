apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: k6-workflow-smoke
  labels:
    core-tests: workflows
spec:
  content:
    git:
      uri: https://github.com/kubeshop/testkube
      revision: main
      paths:
      - test/k6/executor-tests/k6-smoke-test.js
  container:
    resources:
      requests:
        cpu: 128m
        memory: 128Mi
    workingDir: /data/repo/test/k6/executor-tests
  steps:
  - name: Run test
    run:
      image: grafana/k6:0.43.1
      args:
      - run
      - k6-smoke-test.js
      - -e
      - K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value
      env:
      - name: K6_SYSTEM_ENV
        value: K6_SYSTEM_ENV_value
---
apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: k6-workflow-smoke-preofficial-trait
  labels:
    core-tests: workflows
spec:
  container:
    resources:
      requests:
        cpu: 128m
        memory: 128Mi
    workingDir: /data/repo/test/k6/executor-tests
    env:
    - name: K6_SYSTEM_ENV # currently only possible on this level
      value: K6_SYSTEM_ENV_value
  steps:
  - name: Checkout
    content:
      git:
        uri: https://github.com/kubeshop/testkube
        revision: main
        paths:
        - test/k6/executor-tests/k6-smoke-test.js
  - name: Run from trait
    workingDir: /data/repo/test/k6/executor-tests
    template:
      name: pre-official/k6
      config:
        version: 0.48.0
        params: "k6-smoke-test.js -e K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value"
---
apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: k6-workflow-smoke-preofficial-trait-without-checkout-step
  labels:
    core-tests: workflows
spec:
  content:
    git:
      uri: https://github.com/kubeshop/testkube
      revision: main
      paths:
      - test/k6/executor-tests/k6-smoke-test.js
  container:
    resources:
      requests:
        cpu: 128m
        memory: 128Mi
    workingDir: /data/repo/test/k6/executor-tests
    env:
    - name: K6_SYSTEM_ENV # currently only possible on this level
      value: K6_SYSTEM_ENV_value
  steps:
  - name: Run from trait
    workingDir: /data/repo/test/k6/executor-tests
    template:
      name: pre-official/k6
      config:
        version: 0.48.0
        params: "k6-smoke-test.js -e K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value"
---
apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: k6-workflow-smoke-artifacts
  labels:
    core-tests: workflows
spec:
  content:
    git:
      uri: https://github.com/kubeshop/testkube
      revision: main
      paths:
      - test/k6/executor-tests/k6-smoke-test.js
  container:
    resources:
      requests:
        cpu: 128m
        memory: 128Mi
    workingDir: /data/repo/test/k6/executor-tests
  steps:
  - name: Run test
    container:
      image: grafana/k6:0.49.0
    steps:
    - shell: mkdir /data/artifacts
    - run:
        args:
        - run
        - k6-smoke-test.js
        - -e
        - K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value
        env:
        - name: K6_SYSTEM_ENV
          value: K6_SYSTEM_ENV_value
        - name: K6_WEB_DASHBOARD
          value: "true"
        - name: K6_WEB_DASHBOARD_EXPORT
          value: "/data/artifacts/k6-test-report.html"
      steps:
      - name: Saving artifacts
        workingDir: /data/artifacts
        artifacts:
          paths:
          - '*'
---
apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: k6-workflow-distributed-smoke
  labels:
    core-tests: workflows
spec:
  content:
    git:
      uri: https://github.com/kubeshop/testkube
      revision: main
      paths:
        - test/k6/executor-tests/k6-smoke-test.js
  container:
    workingDir: /data/repo/test/k6/executor-tests

  pod:
    serviceAccountName: testkube-api-server

  steps:
    - name: Run test
      distribute:
        count: 10
        timeout: 10m # execution timeout
        logs: true
        files:
          - path: /k6-smoke-test.js
            content: '{{ file("./k6-smoke-test.js") }}'
        pod:
          metadata:
            labels:
              skew: "{{ execution.id }}-k6"
          spec:
            topologySpreadConstraints:
              - maxSkew: 1
                topologyKey: kubernetes.io/hostname
                whenUnsatisfiable: ScheduleAnyway
                labelSelector:
                  matchLabels:
                    skew: "{{ execution.id }}-k6"
        container:
          image: grafana/k6:0.43.1
          args:
            - run
            - /k6-smoke-test.js
            - -e
            - K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value
            - --duration
            - '10s'
            - --vus
            - '1000'
            - --execution-segment
            - '{{ index }}/{{ count }}:{{ index + 1 }}/{{ count }}'
          env:
            - name: K6_SYSTEM_ENV
              value: K6_SYSTEM_ENV_value
          resources:
            requests:
              cpu: 128m
              memory: 128Mi
---
apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: k6-workflow-uneven-distributed-smoke
  labels:
    core-tests: workflows
spec:
  content:
    git:
      uri: https://github.com/kubeshop/testkube
      revision: main
      paths:
        - test/k6/executor-tests/k6-smoke-test.js
  container:
    workingDir: /data/repo/test/k6/executor-tests

  pod:
    serviceAccountName: testkube-api-server

  steps:
    - name: Run test
      distribute:
        matrix:
          distribution: ["0/5:5/10", "5/10:6/10", "6/10:10/10"]
        description: '{{ round(100 * (eval(split(matrix.distribution, ":").1) - eval(split(matrix.distribution, ":").0))) }}% of load'
        timeout: 10m # execution timeout
        logs: true
        files:
          - path: /k6-smoke-test.js
            content: '{{ file("./k6-smoke-test.js") }}'
        pod:
          metadata:
            labels:
              skew: "{{ execution.id }}-k6"
          spec:
            topologySpreadConstraints:
              - maxSkew: 1
                topologyKey: kubernetes.io/hostname
                whenUnsatisfiable: ScheduleAnyway
                labelSelector:
                  matchLabels:
                    skew: "{{ execution.id }}-k6"
        container:
          image: grafana/k6:0.43.1
          args:
            - run
            - /k6-smoke-test.js
            - -e
            - K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value
            - --duration
            - '10s'
            - --vus
            - '1000'
            - --execution-segment
            - '{{ matrix.distribution }}'
          env:
            - name: K6_SYSTEM_ENV
              value: K6_SYSTEM_ENV_value
          resources:
            requests:
              cpu: 128m
              memory: 128Mi
