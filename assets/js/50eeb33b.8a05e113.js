"use strict";(self.webpackChunktestkube_documentation=self.webpackChunktestkube_documentation||[]).push([[7647],{3905:(e,t,i)=>{i.d(t,{Zo:()=>c,kt:()=>h});var o=i(67294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,o)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,o,n=function(e,t){if(null==e)return{};var i,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)i=r[o],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)i=r[o],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var l=o.createContext({}),p=function(e){var t=o.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):a(a({},t),e)),i},c=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var i=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(i),h=n,f=d["".concat(l,".").concat(h)]||d[h]||u[h]||r;return i?o.createElement(f,a(a({ref:t},c),{},{components:i})):o.createElement(f,a({ref:t},c))}));function h(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=i.length,a=new Array(r);a[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,a[1]=s;for(var p=2;p<r;p++)a[p]=i[p];return o.createElement.apply(null,a)}return o.createElement.apply(null,i)}d.displayName="MDXCreateElement"},65847:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var o=i(87462),n=(i(67294),i(3905));const r={},a="Using Istio",s={unversionedId:"articles/istio",id:"articles/istio",title:"Using Istio",description:"An Istio mesh can be configured in several ways.",source:"@site/docs/articles/istio.md",sourceDirName:"articles",slug:"/articles/istio",permalink:"/articles/istio",draft:!1,editUrl:"https://github.com/kubeshop/testkube/tree/develop/docs/docs/articles/istio.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Using a private certificate authority (CA)",permalink:"/articles/private-ca"},next:{title:"Using Vault",permalink:"/articles/vault"}},l={},p=[{value:"Compatibility with Istio",id:"compatibility-with-istio",level:2},{value:"Configurations for Istio installations without native sidecars",id:"configurations-for-istio-installations-without-native-sidecars",level:3},{value:"Disable Istio for test executions of prebuilt/container executors",id:"disable-istio-for-test-executions-of-prebuiltcontainer-executors",level:4},{value:"Disable Istio for agent hooks",id:"disable-istio-for-agent-hooks",level:4},{value:"Disable Istio for operator hooks",id:"disable-istio-for-operator-hooks",level:4},{value:"Define a global test workflows template",id:"define-a-global-test-workflows-template",level:4},{value:"Hold the API server till Istio&#39;s proxy is ready",id:"hold-the-api-server-till-istios-proxy-is-ready",level:4},{value:"Hold worker service till Istio&#39;s proxy is ready",id:"hold-worker-service-till-istios-proxy-is-ready",level:4}],c={toc:p};function u(e){let{components:t,...i}=e;return(0,n.kt)("wrapper",(0,o.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"using-istio"},"Using Istio"),(0,n.kt)("p",null,"An Istio mesh can be configured in several ways."),(0,n.kt)("p",null,"Traffic can be routed to the proxy by using either the ",(0,n.kt)("inlineCode",{parentName:"p"},"istio-init")," container,\nthe ",(0,n.kt)("a",{parentName:"p",href:"https://istio.io/latest/docs/setup/additional-setup/cni/"},"CNI plugin"),", or\n",(0,n.kt)("a",{parentName:"p",href:"https://istio.io/latest/blog/2022/introducing-ambient-mesh/"},"ambient mode"),"\n(currently in ",(0,n.kt)("a",{parentName:"p",href:"https://istio.io/latest/blog/2024/ambient-reaches-beta/"},"beta"),").\nIn ambient mode, the proxy can run as a separate pod, but in the other modes, it\nruns as a sidecar container."),(0,n.kt)("p",null,"If using Kubernetes 1.28+ with the ",(0,n.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/"},(0,n.kt)("inlineCode",{parentName:"a"},"SidecarContainers")," feature\ngate"),"\nenabled and Istio 1.19+, it is highly recommended that Istio be configured to\nuse native sidecars. Without native sidecars, Istio has several issues which can\nbe put in the following buckets:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Networking from within other init containers either bypasses the proxy by\ndefault (non-CNI)\xa0or ",(0,n.kt)("a",{parentName:"li",href:"https://istio.io/latest/docs/setup/additional-setup/cni/#compatibility-with-application-init-containers"},"should be\nconfigured"),"\nto bypass the proxy (CNI plugin)."),(0,n.kt)("li",{parentName:"ul"},"Containers ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/istio/istio/issues/11130"},"must wait for the proxy to be\nready"),", otherwise, network requests\nmay fail."),(0,n.kt)("li",{parentName:"ul"},"Containers, ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/istio/istio/issues/6324"},"especially within batch\njobs"),", must signal to the proxy\nthat they have completed, otherwise, the proxy never exits and the job never\ncompletes.")),(0,n.kt)("h2",{id:"compatibility-with-istio"},"Compatibility with Istio"),(0,n.kt)("p",null,"Testkube has been verified to work with Istio installations utilizing native\nsidecars. Compatibility with ambient mode or the CNI plugin has not been\nverified, but we are ready to support enterprise customers using these\nparticular configurations."),(0,n.kt)("p",null,"Installations that do not currently support native sidecars should apply the\nconfigurations below to utilize Testkube until they can upgrade their cluster to\nenable native sidecars:"),(0,n.kt)("h3",{id:"configurations-for-istio-installations-without-native-sidecars"},"Configurations for Istio installations without native sidecars"),(0,n.kt)("p",null,"All the values mentioned will be from the top of the specified chart."),(0,n.kt)("h4",{id:"disable-istio-for-test-executions-of-prebuiltcontainer-executors"},"Disable Istio for test executions of prebuilt/container executors"),(0,n.kt)("p",null,"Chart ",(0,n.kt)("inlineCode",{parentName:"p"},"testkube"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'testkube-api:\n    jobPodAnnotations:\n        sidecar.istio.io/inject: "false"\n')),(0,n.kt)("h4",{id:"disable-istio-for-agent-hooks"},"Disable Istio for agent hooks"),(0,n.kt)("p",null,"Chart ",(0,n.kt)("inlineCode",{parentName:"p"},"testkube"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'preUpgradeHook:\n    podAnnotations:\n        sidecar.istio.io/inject: "false"\npreUpgradeHookNATS:\n    podAnnotations:\n        sidecar.istio.io/inject: "false"\n')),(0,n.kt)("h4",{id:"disable-istio-for-operator-hooks"},"Disable Istio for operator hooks"),(0,n.kt)("p",null,"Chart ",(0,n.kt)("inlineCode",{parentName:"p"},"testkube"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'testkube-operator:\n    preUpgrade:\n        podAnnotations:\n            sidecar.istio.io/inject: "false"\n    webhook:\n        patch:\n            podAnnotations:\n                sidecar.istio.io/inject: "false"\n')),(0,n.kt)("h4",{id:"define-a-global-test-workflows-template"},"Define a global test workflows template"),(0,n.kt)("p",null,"Chart ",(0,n.kt)("inlineCode",{parentName:"p"},"testkube"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'global:\n    testWorkflows:\n        globalTemplate:\n            enabled: true\n            spec:\n                pod:\n                    annotations:\n                        sidecar.istio.io/inject: "false"\n')),(0,n.kt)("h4",{id:"hold-the-api-server-till-istios-proxy-is-ready"},"Hold the API server till Istio's proxy is ready"),(0,n.kt)("p",null,"This should avoid the issues with the enterprise API pods failing on restart."),(0,n.kt)("p",null,"Chart ",(0,n.kt)("inlineCode",{parentName:"p"},"testkube-enterprise"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"testkube-cloud-api:\n    podAnnotations:\n        proxy.istio.io/config: '{ \"holdApplicationUntilProxyStarts\": true }'\n")),(0,n.kt)("h4",{id:"hold-worker-service-till-istios-proxy-is-ready"},"Hold worker service till Istio's proxy is ready"),(0,n.kt)("p",null,"This should avoid the issues with the worker service pods failing on restart."),(0,n.kt)("p",null,"Chart ",(0,n.kt)("inlineCode",{parentName:"p"},"testkube-enterprise"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"testkube-worker-service:\n    podAnnotations:\n        proxy.istio.io/config: '{ \"holdApplicationUntilProxyStarts\": true }'\n")))}u.isMDXComponent=!0}}]);