"use strict";(self.webpackChunktestkube_documentation=self.webpackChunktestkube_documentation||[]).push([[9091],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var a=n(67294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(n),k=s,b=d["".concat(l,".").concat(k)]||d[k]||p[k]||r;return n?a.createElement(b,o(o({ref:t},c),{},{components:n})):a.createElement(b,o({ref:t},c))}));function k(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,o=new Array(r);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:s,o[1]=i;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},33118:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>i,toc:()=>u});var a=n(87462),s=(n(67294),n(3905));const r={},o="Guide to Deploying Testkube on AWS",i={unversionedId:"articles/deploying-in-aws",id:"articles/deploying-in-aws",title:"Guide to Deploying Testkube on AWS",description:"If you are using Amazon Web Services, this tutorial will show you how to deploy Testkube in EKS and expose it to the Internet with the AWS Load Balancer Controller.",source:"@site/docs/articles/deploying-in-aws.md",sourceDirName:"articles",slug:"/articles/deploying-in-aws",permalink:"/articles/deploying-in-aws",draft:!1,editUrl:"https://github.com/kubeshop/testkube/docs/docs/articles/deploying-in-aws.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Exposing Testkube Dashboard with NGINX Ingress",permalink:"/articles/exposing-testkube-with-ingress-nginx"},next:{title:"Using Testkube from CI/CD",permalink:"/articles/cicd-overview"}},l={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Ingress and Service Resources Configuration",id:"ingress-and-service-resources-configuration",level:2},{value:"Expose Testkube with Only One Load Balancer",id:"expose-testkube-with-only-one-load-balancer",level:2},{value:"Examples of AWS S3 Bucket configuration",id:"examples-of-aws-s3-bucket-configuration",level:2},{value:"Give it a go!",id:"give-it-a-go",level:2}],c={toc:u};function p(e){let{components:t,...r}=e;return(0,s.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"guide-to-deploying-testkube-on-aws"},"Guide to Deploying Testkube on AWS"),(0,s.kt)("p",null,"If you are using ",(0,s.kt)("strong",{parentName:"p"},"Amazon Web Services"),", this tutorial will show you how to deploy Testkube in EKS and expose it to the Internet with the AWS Load Balancer Controller."),(0,s.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,s.kt)("p",null,"First, we will need an existing Kubernetes cluster. Please see the official documentation on how to get started with an Amazon EKS cluster ",(0,s.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html"},"here"),"."),(0,s.kt)("p",null,"Once the cluster is up and running we need to deploy the AWS Load Balancer Controller. For more information, see ",(0,s.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html"},"Installing the AWS Load Balancer Controller add-on"),"."),(0,s.kt)("p",null,"Another important point is ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-sigs/external-dns"},"ExternalDNS"),". It is not compulsory to deploy it into your cluster, but it helps you dynamically manage your DNS records via k8s resources."),(0,s.kt)("p",null,"And last, but not least - install the Testkube CLI. You can download a binary file from our ",(0,s.kt)("a",{parentName:"p",href:"./step1-installing-cli"},"installation")," page. For how to deploy Testkube to your cluster with all the necessary changes, please see the next section."),(0,s.kt)("h2",{id:"ingress-and-service-resources-configuration"},"Ingress and Service Resources Configuration"),(0,s.kt)("p",null,"To deploy and expose Testkube to the outside world, you will need to create two ingresses - Testkube's API and Testkube's Dashboard. In this tutorial, we will be updating ",(0,s.kt)("inlineCode",{parentName:"p"},"values.yaml")," that later will be passed to the ",(0,s.kt)("inlineCode",{parentName:"p"},"helm install")," command."),(0,s.kt)("p",null,"In order to use the AWS Load Balancer Controller we need to create a ",(0,s.kt)("inlineCode",{parentName:"p"},"values.yaml")," file and add the following annotation to the Ingress resources:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"annotations:\n  kubernetes.io/ingress.class: alb\n")),(0,s.kt)("p",null,"Once this annotation is added, Controller creates two ALBs and the necessary supporting AWS resources."),(0,s.kt)("p",null,"The example configuration using HTTPS protocol might look like the following:"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Testkube API Ingress:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'uiIngress:\n  enabled: true\n  annotations:\n    kubernetes.io/ingress.class: alb\n    alb.ingress.kubernetes.io/load-balancer-name: testkube-api\n    alb.ingress.kubernetes.io/target-type: ip\n    alb.ingress.kubernetes.io/backend-protocol: HTTP\n    alb.ingress.kubernetes.io/listen-ports: \'[{"HTTP": 80},{"HTTPS": 443}]\'\n    alb.ingress.kubernetes.io/scheme: internet-facing\n    alb.ingress.kubernetes.io/healthcheck-path: "/health"\n    alb.ingress.kubernetes.io/healthcheck-port: "8088"\n    alb.ingress.kubernetes.io/ssl-redirect: "443"\n    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:*******:certificate/*****"\n  path: /results/v1\n  hosts:\n    - test-api.aws.testkube.io\n')),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Testkube Dashboard Ingress:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'ingress:\n   enabled: true\n   annotations:\n      kubernetes.io/ingress.class: alb\n      alb.ingress.kubernetes.io/load-balancer-name: testkube-dashboard\n      alb.ingress.kubernetes.io/target-type: ip\n      alb.ingress.kubernetes.io/backend-protocol: HTTP\n      alb.ingress.kubernetes.io/listen-ports: \'[{"HTTP": 80},{"HTTPS": 443}]\'\n      alb.ingress.kubernetes.io/scheme: internet-facing\n      alb.ingress.kubernetes.io/healthcheck-path: "/"\n      alb.ingress.kubernetes.io/healthcheck-port: "8080"\n      alb.ingress.kubernetes.io/ssl-redirect: \'443\'\n      alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:****:*****"\npath: /\n   hosts:\n     - test-dash.aws.testkube.io\n')),(0,s.kt)("admonition",{type:"caution"},(0,s.kt)("p",{parentName:"admonition"},"Do not forget to add ",(0,s.kt)("inlineCode",{parentName:"p"},"apiServerEndpoint")," to the ",(0,s.kt)("inlineCode",{parentName:"p"},"values.yaml")," for ",(0,s.kt)("inlineCode",{parentName:"p"},"testkube-dashboard"),", e.g.: ",(0,s.kt)("inlineCode",{parentName:"p"},'apiServerEndpoint: "test-api.aws.testkube.io/results/v1"'),".")),(0,s.kt)("p",null,"Once we are ready with the ",(0,s.kt)("inlineCode",{parentName:"p"},"values.yaml")," file, we can deploy Testkube into our cluster:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"helm repo add kubeshop https://kubeshop.github.io/helm-chart\n\nhelm repo update\n\nhelm install --create-namespace testkube kubeshop/testkube --namespace testkube --values values.yaml\n")),(0,s.kt)("p",null,"After the installation command is complete, you will see the following resources created into your AWS Console."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"AWS Console",src:n(33283).Z,width:"1600",height:"362"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"AWS Console2",src:n(98111).Z,width:"1600",height:"586"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"AWS Console3",src:n(91427).Z,width:"1600",height:"564"})),(0,s.kt)("p",null,"Please note that the annotations may vary, depending on your Load Balancer schema type, backend-protocols (you may use http only), target-type, etc. However, this is the bare minimum that should be applied to your configuration."),(0,s.kt)("h2",{id:"expose-testkube-with-only-one-load-balancer"},"Expose Testkube with Only One Load Balancer"),(0,s.kt)("p",null,"The above configuration creates two Load Balancers - one for the Dashboard, another is for the API. However, it is possible to save costs and use only 1 Balancer, thus you need to create only one Ingress manifest that will comprise configuration for both services:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: testkube-ingress\n  annotations:\n    kubernetes.io/ingress.class: alb\n    alb.ingress.kubernetes.io/load-balancer-name: testkube\n    alb.ingress.kubernetes.io/target-type: ip\n    alb.ingress.kubernetes.io/backend-protocol: HTTP\n    alb.ingress.kubernetes.io/listen-ports: \'[{"HTTP": 80},{"HTTPS": 443}]\'\n    alb.ingress.kubernetes.io/scheme: internet-facing\n    alb.ingress.kubernetes.io/ssl-redirect: "443"\n    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:*****:certificate/******"\nspec:\n  rules:\n    - host: test-dash.aws.testkube.io\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: testkube-dashboard\n                port:\n                  number: 8080\n    - host: test-api.aws.testkube.io\n      http:\n        paths:\n          - path: /results/v1\n            pathType: Prefix\n            backend:\n              service:\n                name: testkube-api-server\n                port:\n                  number: 8088\n')),(0,s.kt)("p",null,"Except for the Ingress annotation, you need to update the Service manifests with a healthcheck configuration as well. Include the lines below into your ",(0,s.kt)("inlineCode",{parentName:"p"},"values.yaml")," file."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Testkube Dashboard Service:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'service:\n  type: ClusterIP\n  port: 8080\n  annotations:\n    alb.ingress.kubernetes.io/healthcheck-path: "/"\n    alb.ingress.kubernetes.io/healthcheck-port: "8080"\n')),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Testkube API Service:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'service:\n  type: ClusterIP\n  port: 8088\n  annotations:\n    alb.ingress.kubernetes.io/healthcheck-path: "/health"\n    alb.ingress.kubernetes.io/healthcheck-port: "8088"\n')),(0,s.kt)("admonition",{type:"caution"},(0,s.kt)("p",{parentName:"admonition"},"Do not forget to add ",(0,s.kt)("inlineCode",{parentName:"p"},"apiServerEndpoint")," to the values.yaml for ",(0,s.kt)("inlineCode",{parentName:"p"},"testkube-dashboard"),", e.g.: ",(0,s.kt)("inlineCode",{parentName:"p"},'apiServerEndpoint: "test-api.aws.testkube.io/results/v1"'),".")),(0,s.kt)("p",null,"This way we will have 1 Load Balancer with two listener rules pointing on corresponding paths:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"One Load Balancer",src:n(88565).Z,width:"1600",height:"307"})),(0,s.kt)("h2",{id:"examples-of-aws-s3-bucket-configuration"},"Examples of AWS S3 Bucket configuration"),(0,s.kt)("p",null,"If you plan to use AWS S3 Bucket for storing test artifacts, you can follow below examples"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Terraform aws iam policy:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'data "aws_iam_policy_document" "testkube" {\n  statement {\n    sid    = "S3Buckets"\n    effect = "Allow"\n    actions = [\n      "s3:ListAllMyBuckets", # see https://github.com/kubeshop/testkube/issues/3965\n    ]\n    resources = [\n      "arn:aws:s3:::*",\n    ]\n  }\n  statement {\n    sid    = "S3Bucket"\n    effect = "Allow"\n    actions = [\n      "s3:ListBucket",\n      "s3:GetBucketLocation",\n    ]\n    resources = [\n      "arn:aws:s3:::*-testkube-${terraform.workspace}",\n    ]\n  }\n  statement {\n    sid    = "S3Object"\n    effect = "Allow"\n    actions = [\n      "s3:GetObject*",\n      "s3:PutObject*",\n      "s3:DeleteObject",\n    ]\n    resources = [\n      "arn:aws:s3:::*-testkube-${terraform.workspace}/*",\n    ]\n  }\n')),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Teskube helm values:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'  testkube-api:\n    jobServiceAccountName: testkube-api-server # reuse the service-account from testkube-api\n    minio:\n      enabled: true # required to be able to access AWS S3 (minio is used as a proxy)\n      minioRootUser: ""\n      minioRootPassword: ""\n      serviceAccountName: testkube-api-server # reuse the service-account from testkube-api\n    serviceAccount:\n      annotations:\n        eks.amazonaws.com/role-arn: arn:aws:iam::111111111111:role/my-dev-testkube\n    storage:\n      endpoint: s3.amazonaws.com\n      accessKeyId: ""\n      accessKey: ""\n      location: eu-central-1\n      bucket: my-testkube-dev\n      SSL: true\n      endpoint_port: ""\n    logs:\n      storage: "minio"\n      bucket: my-testkube-dev\n')),(0,s.kt)("h2",{id:"give-it-a-go"},"Give it a go!"),(0,s.kt)("p",null,"With just a few changes you can deploy Testkube into an EKS cluster and expose it to the outside world while all the necessary resources are created automatically."),(0,s.kt)("p",null,"If you have any questions you can ",(0,s.kt)("a",{parentName:"p",href:"https://discord.com/invite/6zupCZFQbe"},"join our Discord community")," or, if you have any ideas for other useful features, you can create feature requests at our ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/kubeshop/testkube"},"GitHub Issues")," page."))}p.isMDXComponent=!0},98111:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/aws-resource-console-2-dd5cd97254d4e6e1656e0978239cbd79.png"},91427:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/aws-resource-console-3-1a861b72eec7e3eba406adbe8207db90.png"},33283:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/aws-resource-console-048d598d4a298246e5ac0aadf0e8ae2d.png"},88565:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/one-load-balancer-0809e391eb4f677d6fb08864ee66aa90.png"}}]);